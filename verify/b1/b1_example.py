import time

import numpy as np

from abstract.b1.b1_abs import *
from verify.divide_tool import initiate_divide_tool
from verify.b1.b1_env import B1_Env

initial_intervals = [0.02, 0.02]
# initial_intervals = [0.03, 0.03]
# initial_intervals = [0.04, 0.04]
# initial_intervals = [0.05, 0.05]
# initial_intervals = [0.01, 0.01]
initial_intervals = [0.002, 0.002]
# divide_tool = initiate_divide_tool_rtree(state_space, initial_intervals, [0, 1], file_name)
divide_tool = initiate_divide_tool(state_space, initial_intervals)
agent = Agent(divide_tool)
# train_model(agent)
agent.load()
min_r = evaluate(agent)
print(min_r)

# trace_list = evaluate_trace(agent)
# np.save('./traces/b1_trace_list', arr=trace_list)

b1 = B1_Env(divide_tool, agent.network)

# high = np.array([0.9, 0.6])
# low = np.array([0.8, 0.5])
r = [0.8, 0.5, 0.9, 0.6]
# r = [0.8, 0.51, 0.81, 0.52]
# r = [0.89, 0.59, 0.9, 0.6]
r = [0.89, 0.53, 0.9, 0.54]
t = 0
interval_num_agg = []

st = time.time()
bound_list = [r]
while True:
    t0 = time.time()
    bound_list = b1.get_next_bound_list(bound_list)
    min_x1 = 100
    max_x1 = -100
    min_x2 = 100
    max_x2 = -100

    for bound in bound_list:
        min_x1 = min(bound[0], min_x1)
        max_x1 = max(bound[2], max_x1)
        min_x2 = min(bound[1], min_x2)
        max_x2 = max(bound[3], max_x2)

    t1 = time.time()
    # print(t, '：', r[2], r[6])
    print(t, '：', len(bound_list), min_x1, max_x1, min_x2, max_x2, t1 - t0)
    interval_num_agg.append(len(bound_list))

    t += 1
    if t == 70:
        break
et = time.time()
np.save('interval_number_no_agg', arr=interval_num_agg)
print(et - st)
print('seg', b1.time_seg, 'over-app', b1.time_op, 'agg', b1.time_agg)


# 0 ： 36    0.8500000000000001 0.96 0.31357183218002316 0.3808731489181518 0.006604671478271484
# 1 ： 105   0.8821116375207902 0.9973637256622314 0.1806127033715471 0.23882722189416486 0.01900792121887207
# 2 ： 205   0.9016306892057138 1.0199582834142324 0.06983756637024971 0.12727394711166493 0.03735208511352539
# 3 ： 368   0.9107504176534279 1.030809824002586 -0.03226732549680583 0.029088468381202978 0.06686758995056152
# 4 ： 567   0.9104154887950885 1.031195939615006 -0.13368713010227684 -0.06430611174996048 0.10234713554382324
# 5 ： 853   0.9008801224920764 1.0213814907183085 -0.2409943858247654 -0.15910902327762483 0.1601567268371582
# 6 ： 1272  0.8817926177568374 1.0010049254984494 -0.3544517051644645 -0.2609764381183156 0.24404358863830566
# 7 ： 1888  0.8523214519799739 0.9692792845799635 -0.4363059899543926 -0.366546788023663 0.36226892471313477
# 8 ： 2733  0.81245840653429 0.9279426607279416 -0.4779973093070653 -0.4376699818686939 0.5261268615722656
# 9 ： 3576  0.7666378077798968 0.881574971021272 -0.4979723958913666 -0.47052857030322903 0.6921052932739258
# 10 ： 4559     0.7183139294288239 0.8326168516773641 -0.5058992221849122 -0.4844767154286681 0.8828673362731934
# 11 ： 5894     0.669338904819131 0.7824485574114947 -0.5068520764191199 -0.4864277567114261 1.121382236480713
# 12 ： 7611     0.6203640650129251 0.7320354393029989 -0.503696701863735 -0.48298632883572723 1.398965835571289
# 13 ： 9107     0.57184570678967 0.6818760133959928 -0.49708288311160287 -0.4754691792166729 1.6978533267974854
# 14 ： 10626    0.5241067242869596 0.6323018167749271 -0.4911698151948489 -0.4681517021617496 2.0406272411346436
# 15 ： 12547    0.4771202098947183 0.5832820809167562 -0.48202769965965686 -0.4566333846622489 2.336853265762329
# 16 ： 14256 0.4313087329430439 0.5351422429209908 -0.47285046888352217 -0.44254686859246856 2.6692111492156982
# 17 ： 16866 0.38671270025774507 0.48816837476549085 -0.4609769645622303 -0.4261762593880222 3.1742680072784424
# 18 ： 19131 0.34383469658977145 0.44229629552766875 -0.4494207841201553 -0.40987431125505275 3.555924415588379
# 19 ： 22188 0.3026451473451599 0.3974344880350796 -0.43390291948243453 -0.3926844246182732 4.161823511123657
# 20 ： 25132 0.26321767526360207 0.35410405782910376 -0.4164678144563821 -0.3737999469437097 4.785438060760498
# 21 ： 28928 0.22571123038666688 0.3125195485645552 -0.3984143210493326 -0.3527217166724941 5.546100854873657
# 22 ： 34469 0.19032121297113466 0.2727431872687176 -0.37883716965670766 -0.3300939446627646 6.523134708404541
# 23 ： 39706 0.15719156851758573 0.2349273491290121 -0.3573439748204513 -0.30734802109417503 7.455204248428345
# 24 ： 45048 0.12633317511133357 0.1992634185572167 -0.33444543067114196 -0.285769154585823 8.518143892288208
# 25 ： 51009 0.09763464103891131 0.16589179129153936 -0.311484983598686 -0.2659656315813711 9.432264804840088
# 26 ： 57541 0.07091480695212495 0.13481896065842858 -0.2903669513300679 -0.24746913224867545 11.191281795501709
# 27 ： 63394 0.046047226022416635 0.10602460404822563 -0.2703598446524011 -0.2300771506298868 12.204853534698486
# 28 ： 70205 0.022917891787637396 0.0792864260327074 -0.2518072231235999 -0.2135124268686346 13.342358589172363
# 29 ： 78259 0.001418166660517136 0.05439828781421295 -0.23434884955433366 -0.19757106836523858 14.754863977432251
# 30 ： 85213 -0.018521841961795103 0.03125635118913571 -0.21776792143673737 -0.18210233883877278 16.141048908233643
# 31 ： 91828 -0.0369127412047552 0.0097773708647499 -0.20184875712127878 -0.166993613632158 17.450260877609253
# 32 ： 103861 -0.05379415073498397 -0.010101104480022525 -0.18647743368556283 -0.15215962318342663 19.591902256011963
# 33 ： 121802 -0.06919669318084684 -0.02842614599235034 -0.17154612495725807 -0.1375346139396661 22.99358868598938
# 34 ： 138906 -0.08330426822607576 -0.045235099862756964 -0.15691028907113605 -0.12306697493352049 26.214682817459106
# 35 ： 151652 -0.09616124825368301 -0.0605560411616276 -0.14250795953576492 -0.10871504791649485 28.719022274017334
# 36 ： 166021 -0.10755711504727315 -0.0744099302038473 -0.1282914943376118 -0.09444425581849253 31.46550416946411
# 37 ： 182323 -0.11750835791335684 -0.08681215324266761 -0.11421499637129774 -0.08022644418076325 34.69672083854675
# 38 ： 218522 -0.12602771644745503 -0.0977991665275243 -0.10025174239005577 -0.06602137654055219 41.01069521903992
# 39 ： 234002 -0.13312480621172823 -0.10737730695122333 -0.08637624356790045 -0.05181113770631736 44.25076603889465
# 40 ： 283603 -0.13880677306684372 -0.11558856706720631 -0.07253683187020218 -0.03758382732978436 53.21113657951355
# 41 ： 312052 -0.14307864568565293 -0.12243164118800433 -0.058716821182722895 -0.0233180514745574 58.78848457336426
# 42 ： 327401 -0.14594368838442134 -0.12790397766897466 -0.04490180229775332 -0.008999685814954111 61.99275994300842
# 43 ： 370138 -0.1473759110663237 -0.13200179334820958 -0.031178274092699295 0.005394817178628856 70.08779811859131
# 44 ： 536145 -0.147374452517971 -0.1347199844914723 -0.017470856892086897 0.01988699909364642 100.70314764976501
# 45 ： 706570 -0.1471550160907395 -0.13396754923103338 -0.003762702275787795 0.034589175870431525 133.204008102417
# 46 ： 912765 -0.14707996740101353 -0.13109230074470726 0.009945747238317289 0.0495316376068871 172.58685731887817
# 47 ： 1268807 -0.14562519917102168 -0.12679755180768257 0.023688086275608006 0.06466366494607169 238.2562177181244
# 48 ： 1510334 -0.1427291664853736 -0.12106979697276801 0.037475204864876835 0.08002802815509667 285.0362594127655
# 49 ： 1662316 -0.1383851741371116 -0.11389248979532894 0.051301532910319914 0.09567223799392066 313.95911383628845
# 50 ： 1810621 -0.13256575548186672 -0.10524559104822916 0.06513788317353725 0.11162842675108853 343.0645999908447
# 51 ： 2197601 -0.12525919769928162 -0.09510522800821683 0.07907441096862484 0.12800697000148908 414.09754967689514
# 52 ： 2484905 -0.11644757790883722 -0.08329935453346089 0.09312551790428227 0.14483766100233567 469.70377230644226
# 53 ： 3164308 -0.10610954857614341 -0.06941880154244484 0.10733793359497143 0.16197380164748548 597.0403738021851
# 54 ： 3706874 -0.09422098784690414 -0.053766409465877345 0.12170791558039715 0.1786674597105421 698.4677195549011
# 55 ： 4487207 -0.08109471954487693 -0.036475868860070815 0.13621360936068072 0.19585206436361668 848.0184330940247
# 56 ： 5605713 -0.06695797559456909 -0.017645459984240726 0.15081494371295817 0.20999639770436704 1053.111046075821
# 57 ： 7210875 -0.05158407329007297 0.0025796389286127062 0.1652529837155635 0.21752604153188138 1354.5168590545654
# 58 ： 9015713 -0.03468208294451332 0.02303773293446864 0.17806261434077994 0.21852273781464615 1701.745087146759
# 59 ： 12335485 -0.016504009223713617 0.043078084969729126 0.18287160984885054 0.21774289877768666 2323.0779283046722
# 60 ： 15652181 0.0024515100038105114 0.06338040010707821 0.1692122313126222 0.21748097084110374 2962.5149734020233
# 14654.732525587082
# seg 2089.136328935623 over-app 12341.982875347137 agg 43.9828314781189



